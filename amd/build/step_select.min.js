define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/ajax","core/fragment","core/notification"],function(a,b,c,d,e,f,g,h){function i(){var b=a("[name=stepjson]").val(),c=[];return""!==b&&(c=JSON.parse(b)),c}function j(b){a("[name=stepjson]").val(JSON.stringify(b)),a("[name=isstepschanged]").val(1)}function k(){var a={},b={jsonformdata:JSON.stringify(a)};t.setBody(v),t.setBody(g.loadFragment("tool_trigger","new_base_form",s,b))}function l(b){var c=b.map(function(a,b){return{type:a.type,name:a.name,step:a.step,steporder:b}}),d={rows:c};e.render("tool_trigger/workflow_steps",d).then(function(b){a("#steps-table").html(b),r()}).fail(function(){h.exception({message:"Error updating steps table"})})}function m(b){b.preventDefault();var c=t.getRoot().find("form"),d=c.serializeArray().reduce(function(a,b){return"sesskey"===b.name||b.name.startsWith("_qf__")||(a[b.name]=b.value),a},{});d.step=a("[name=stepclass] option:selected").text(),f.call([{methodname:"tool_trigger_validate_form",args:{stepclass:d.stepclass,jsonformdata:JSON.stringify(c.serialize())}}])[0].done(function(){var a=i();d.steporder>=0?a[d.steporder]=d:(a.push(d),d.steporder=a.length-1),j(a),l(a),t.hide()}).fail(function(){p(d.type,d.stepclass,"",c.serialize())})}function n(b){a("[name=stepclass]").empty().append(a("<option>",{value:"",text:"Choose..."})),a.each(b,function(b,c){a("[name=stepclass]").append(a("<option>",{value:c["class"],text:c.name}))})}function o(a){f.call([{methodname:"tool_trigger_step_by_type",args:{steptype:a}}])[0].done(function(a){n(a)})}function p(a,b,c,d){void 0===c&&(c=""),void 0===d&&(d=""),t.setBody(v),t.setBody(g.loadFragment("tool_trigger","new_step_form",s,{steptype:a,stepclass:b,defaults:JSON.stringify(c),ajaxformdata:d}))}function q(){a("body").on("change","[name=type]",function(){o(this.value)}),a("body").on("change","[name=stepclass]",function(){var b=a("[name=type]").val(),c=this.value;p(b,c)})}function r(){a(".tool-trigger-step-moveup").on("click",function(){var b=i(),c=a(this).data("steporder");if(0===c)return!0;var d=c-1,e=c,f=b[e],g=b[d];return f.steporder=d,g.steporder=e,b[d]=f,b[e]=g,j(b),l(b),!0}),a(".tool-trigger-step-movedown").on("click",function(){var b=i(),c=a(this).data("steporder");if(c>=b.length-1)return!0;var d=c,e=c+1,f=b[e],g=b[d];return f.steporder=d,g.steporder=e,b[d]=f,b[e]=g,j(b),l(b),!0}),a(".tool-trigger-step-delete").on("click",function(){var b=i(),c=a(this).data("steporder");return b.splice(c,1),c<=b.length&&b.slice(c).forEach(function(a){a.steporder=a.steporder-1}),j(b),l(b),!0}),a(".tool-trigger-step-edit").on("click",function(){t.setBody(v),t.show();var b=i(),c=a(this).data("steporder"),d=b[c];p(d.type,d.stepclass,d)})}var s,t,u={},v='<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i><span class="sr-only">Loading...</span></p>';return u.init=function(e){s=e,b.get_string("modaltitle","tool_trigger").then(function(b){c.create({type:c.types.SAVE_CANCEL,title:b,body:v,large:!0},a("#id_step_modal_button")).done(function(a){t=a,t.getRoot().on(d.save,m),t.getRoot().on(d.hidden,k),q(),k()})}),r()},u});