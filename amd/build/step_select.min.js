define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/ajax","core/fragment"],function(a,b,c,d,e,f,g){function h(){var b=a("[name=stepjson]").val(),c=[];return""!==b&&(c=JSON.parse(b)),c}function i(b){a("[name=stepjson]").val(JSON.stringify(b)),a("[name=isstepschanged]").val(1)}function j(){var a={},b={jsonformdata:JSON.stringify(a)};s.setBody(u),s.setBody(g.loadFragment("tool_trigger","new_base_form",r,b))}function k(b){var c=b.map(function(a,b){return{type:a.type,name:a.name,step:a.step,steporder:b}}),d={rows:c};e.render("tool_trigger/workflow_steps",d).then(function(b){a("#steps-table").html(b),q()}).fail(function(){Notification.exception({message:"Error updating steps table"})})}function l(b){b.preventDefault();var c=s.getRoot().find("form"),d=c.serializeArray().reduce(function(a,b){return"sesskey"===b.name||b.name.startsWith("_qf__")||(a[b.name]=b.value),a},{});d.step=a("[name=stepclass] option:selected").text(),f.call([{methodname:"tool_trigger_validate_form",args:{stepclass:d.stepclass,jsonformdata:JSON.stringify(c.serialize())}}])[0].done(function(){var a=h();d.steporder>=0?a[d.steporder]=d:(a.push(d),d.steporder=a.length-1),i(a),k(a),s.hide()}).fail(function(){o(d.type,d.stepclass,"",c.serialize())})}function m(b){a("[name=stepclass]").empty().append(a("<option>",{value:"",text:"Choose..."})),a.each(b,function(b,c){a("[name=stepclass]").append(a("<option>",{value:c["class"],text:c.name}))})}function n(a){f.call([{methodname:"tool_trigger_step_by_type",args:{steptype:a}}])[0].done(function(a){m(a)})}function o(a,b,c,d){void 0===c&&(c=""),void 0===d&&(d=""),s.setBody(u),s.setBody(g.loadFragment("tool_trigger","new_step_form",r,{steptype:a,stepclass:b,defaults:JSON.stringify(c),ajaxformdata:d}))}function p(){a("body").on("change","[name=type]",function(){n(this.value)}),a("body").on("change","[name=stepclass]",function(){var b=a("[name=type]").val(),c=this.value;o(b,c)})}function q(){a(".tool-trigger-step-moveup").on("click",function(){var b=h(),c=a(this).data("steporder");if(0===c)return!0;var d=c-1,e=c,f=b[e],g=b[d];return f.steporder=d,g.steporder=e,b[d]=f,b[e]=g,i(b),k(b),!0}),a(".tool-trigger-step-movedown").on("click",function(){var b=h(),c=a(this).data("steporder");if(c>=b.length-1)return!0;var d=c,e=c+1,f=b[e],g=b[d];return f.steporder=d,g.steporder=e,b[d]=f,b[e]=g,i(b),k(b),!0}),a(".tool-trigger-step-delete").on("click",function(){var b=h(),c=a(this).data("steporder");return b.splice(c,1),c<=b.length&&b.slice(c).forEach(function(a){a.steporder=a.steporder-1}),i(b),k(b),!0}),a(".tool-trigger-step-edit").on("click",function(){s.setBody(u),s.show();var b=h(),c=a(this).data("steporder"),d=b[c];o(d.type,d.stepclass,d)})}var r,s,t={},u='<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i><span class="sr-only">Loading...</span></p>';return t.init=function(e){r=e,b.get_string("modaltitle","tool_trigger").then(function(b){c.create({type:c.types.SAVE_CANCEL,title:b,body:u,large:!0},a("#id_step_modal_button")).done(function(a){s=a,s.getRoot().on(d.save,l),s.getRoot().on(d.hidden,j),p(),j()})}),q()},t});